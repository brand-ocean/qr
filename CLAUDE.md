# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a modern React Native & Expo mobile application (iOS & Android only, no web) built with the New Architecture. The project uses Expo Router for file-based routing, NativeWind/Tailwind for styling, and fbtee for internationalization.

**Key Technologies:**

- Expo 54 & React Native 0.81 with New Architecture
- Expo Router for file-based navigation
- NativeWind (Tailwind CSS for React Native)
- TypeScript with strict mode & ESM (type: "module")
- React Compiler for optimizations
- fbtee for i18n (with Japanese translations as an example)
- pnpm for package management
- Vitest for testing

## Development Commands

### Setup & Installation

```bash
# Install dependencies and setup i18n
pnpm install && pnpm dev:setup

# Just install dependencies
pnpm install

# Setup i18n (collect and translate strings)
pnpm dev:setup
# or manually:
pnpm fbtee collect && pnpm fbtee translate
```

### Running the App

```bash
# Development server (for already-installed app on simulator)
pnpm dev

# Build and run iOS (on iPhone 16 Pro simulator)
pnpm prebuild  # First time only
pnpm ios

# Run Android
pnpm android

# Start with dev client
pnpm start
```

### Testing & Quality

```bash
# Run all tests, type checks, and linting
pnpm test

# Individual commands:
pnpm tsc:check      # TypeScript type checking
pnpm vitest:run     # Run unit tests
pnpm lint           # ESLint
pnpm lint:format    # Check Prettier formatting
pnpm format         # Auto-format with Prettier
```

## Architecture

### Directory Structure

```
src/
├── app/              # Expo Router file-based routing
│   ├── _layout.tsx   # Root layout with LocaleContext, ViewerContext, GestureHandler
│   ├── login.tsx     # Login screen
│   └── (app)/        # Authenticated app routes
│       ├── _layout.tsx   # Auth guard (redirects to /login if not authenticated)
│       └── (tabs)/       # Tab-based navigation
├── ui/               # Reusable UI components
│   ├── colors.ts     # Color definitions (imported by Tailwind)
│   ├── Text.tsx      # Custom Text component
│   └── BottomSheetModal.tsx
├── user/             # User authentication & context
│   └── useViewerContext.tsx  # Authentication state, login/logout, MMKV storage
├── lib/              # Utility functions
│   └── cx.tsx        # Classname utilities
├── tests/            # Test files
└── translations/     # i18n JSON files (generated by fbtee)
```

### Routing Architecture (Expo Router)

- **Root Layout** (`src/app/_layout.tsx`): Sets up global contexts (LocaleContext, ViewerContext, GestureHandlerRootView)
- **App Layout** (`src/app/(app)/_layout.tsx`): Protects authenticated routes, redirects to `/login` if not authenticated
- **Tab Layout** (`src/app/(app)/(tabs)/_layout.tsx`): Tab navigation structure

### Authentication Flow

Authentication is managed through `ViewerContext` (`src/user/useViewerContext.tsx`):

- Uses `react-native-mmkv` for persistent local storage (per-user settings)
- `login()` sets viewer context and navigates to home
- `logout()` clears context and navigates to root
- `isAuthenticated` checks if user is logged in
- Routes in `(app)` group require authentication

### Styling System

- **NativeWind**: Tailwind CSS for React Native via `className` prop
- **Color System**: Colors defined in `src/ui/colors.ts` are converted to CSS variables in `tailwind.config.ts`
- Use Tailwind utility classes directly in components

### Internationalization (i18n)

- **fbtee** for translations (Facebook's i18n framework)
- Source strings stored in `source_strings.json`
- Translations in `src/translations/*.json` (e.g., `ja_JP.json`)
- Run `pnpm dev:setup` after adding new translatable strings
- Use `<fbt>` tags in JSX for translatable text

## Configuration Files

- **tsconfig.json**: Strict TypeScript with ESM (`module: "nodenext"`)
- **babel.config.js**: Uses `@nkzw/babel-preset-fbtee`, `babel-preset-expo`, and `nativewind/babel`
- **vitest.config.js**: React Native testing setup with fbtee support
- **tailwind.config.ts**: Custom color system with CSS variables

## Important Notes

- This project uses ESM (`"type": "module"`), so imports require `.ts`/`.tsx` extensions
- Node.js 24, pnpm 10+, and Cocoapods required
- Git hooks configured via `core.hooksPath git-hooks` (set on preinstall)
- React Compiler is enabled for automatic optimizations
- Never use `ANY` or `UNKNOWN` types (per user's global rules)
